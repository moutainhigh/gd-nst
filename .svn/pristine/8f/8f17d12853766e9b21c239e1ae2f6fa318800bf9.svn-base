<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="OrderBefore">
	<sql id="insert">
<![CDATA[
	INSERT INTO order_before (
		sourceId,
		carId,
		shipperMemberId,
		driverMemberId,
		sourceStatus,
		createUserId,
		createTime
	)
	VALUES
	(
		:sourceId ,
		:carId,
		:shipperMemberId ,
		:driverMemberId ,
		:sourceStatus ,
		:createUserId,
		now()
	)
]]>
	</sql>

	<!-- 根据货源ID 查询订单操作日志 -->
	<sql id="queryOrderOperateLog">
<![CDATA[
	select description,createTime  from source_log  where sourceId=:sourceId	
]]>
	</sql>

	<sql id="update">
<![CDATA[
	update  order_before set 
		sourceStatus=:sourceStatus,
		updateTime=now(),
		updateUserId=:driverMemberId
		where  1=1 
		<#if sourceId?exists && sourceId!="" >
			AND sourceId=:sourceId
		</#if>
		<#if shipperMemberId?exists && shipperMemberId!="" >
			AND shipperMemberId=:shipperMemberId
		</#if>
		<#if driverMemberId?exists && driverMemberId!="" >
			AND driverMemberId=:driverMemberId
		</#if>
		<#if id?exists && id!="" >
			AND id=:id
		</#if>
]]>
	</sql>

	<sql id="queryOrderBeforeById">
		<![CDATA[
			select
				id, 
			    sourceId,
				carId,
				shipperMemberId,
				driverMemberId,
				sourceStatus,
				createUserId,
				createTime
			from order_before 
			where 1=1
				<#if id?exists && id!="" >
					AND id=:id
				</#if>
				<#if sourceId?exists && sourceId!="" >
					AND sourceId=:sourceId
				</#if>
				<#if sourceStatus?exists && sourceStatus!="" >
					AND sourceStatus=:sourceStatus
				</#if>
				
		]]>
	</sql>

	<!-- 查询货主直发的货源 -->
	<sql id="queryByShipper">
		<![CDATA[
				SELECT
					*
				FROM
					(
						SELECT
							ob.id AS id,
							ob.sourceId AS sourceId,
							s.s_detail AS s_Detail,
							s.s_detailed_address AS s_DetailedAddress,
							s.e_detail AS e_Detail,
							s.e_detailed_address AS e_DetailedAddress,
							s.mileage AS mileage,
							s.sendDate AS sendDate,
							s.carLength AS carLength,
							s.carType AS carType,
							s.sendGoodsType AS sendGoodsType,
							s.goodsName AS goodsName,
							s.totalWeight AS totalWeight,
							s.totalSize AS totalSize,
							s.remark AS remark,
							s.freight AS freight,
							s.nstRule AS nstRule,
							mr.carNumber AS driverCarNumber,
							mr.carType AS driverCarType,
							mr.`load` AS driverCarLoad,
							mr.carLength AS driverCarLength,
							mc.realName AS shipperRealName,
							mc.cerStatus AS shipperCerStatus,
							mi.mobile AS shipperMobile,
							mi.iconUrl AS shipperIconUrl,
							mc.companyName AS companyName,
							oi.orderNo AS orderInfoNo,
							oi.orderStatus AS orderInfoStatus,
							oi.confirmOrderTime AS confirmOrderInfoTime,
							oi.confirmGoodsTime AS confirmGoodsInfoTime,
							op.payMoney AS payMoney,
							op.payStatus AS payStatus,
							op.payTime AS payTime,
							op.platformPayWater AS platformPayWater,
							op.payName AS payName
						FROM
							order_before ob
						INNER JOIN source_shipper s ON (ob.sourceId = s.id)
						INNER JOIN member_info mi ON mi.id = s.memberId
						LEFT JOIN member_cer mc ON mc.memberId = mi.id
						LEFT JOIN order_info oi ON oi.sourceId = ob.sourceId
						LEFT JOIN member_car mr ON mr.id = ob.carId
						LEFT JOIN order_paydetail op ON (
							op.orderNo = oi.orderNo
							AND op.orderType = 2
						)
						WHERE ob.id=:id
					) t
				LEFT JOIN (
					SELECT
						ob.sourceId,
						mc.realName AS driverRealName,
						mc.cerStatus AS driverCerStatus,
						mi.mobile AS driverMobile,
						mi.iconUrl AS driverIconUrl
					FROM
						order_before ob
					INNER JOIN member_info mi ON mi.id = ob.driverMemberId
					LEFT JOIN member_cer mc ON mc.memberId = mi.id
					WHERE
					 ob.id=:id
				) p ON t.sourceId = p.sourceId
		
		]]>
	</sql>
	<!-- 查询物流公司分配的货源 -->
	<sql id="queryByLogistics">
		<![CDATA[
				SELECT
					*
				FROM
					(
						SELECT
							ob.id AS id,
							ob.sourceId AS sourceId,
							s.s_detail AS s_Detail,
							s.s_detailed_address AS s_detailed_address,
							s.e_detail AS e_Detail,
							s.e_detailed_address AS e_detailed_address,
							s.mileage AS mileage,
							s.sendDate AS sendDate,
							s.carLength AS carLength,
							s.carType AS carType,
							s.sendGoodsType AS sendGoodsType,
							s.goodsName AS goodsName,
							s.totalWeight AS totalWeight,
							s.totalSize AS totalSize,
							s.remark AS remark,
							s.freight AS freight,
							s.nstRule AS nstRule,
							mr.carNumber AS driverCarNumber,
							mr.carType AS driverCarType,
							mr.`load` AS driverCarLoad,
							mr.carLength AS driverCarLength,
							mc.realName AS shipperRealName,
							mc.cerStatus AS shipperCerStatus,
							mi.mobile AS shipperMobile,
							mi.iconUrl AS shipperIconUrl,
							mc.companyName AS companyName,
							oi.orderNo AS orderInfoNo,
							oi.orderStatus AS orderInfoStatus,
							oi.confirmOrderTime AS confirmOrderInfoTime,
							oi.confirmGoodsTime AS confirmGoodsInfoTime,
							oa.orderNo AS orderAgentNo,
							oa.orderStatus AS orderAgentStatus,
							oa.confirmTime AS agentConfirmTime,
							oa.logisticTime AS agentLogisticTime,
							op.payMoney AS orderInfoPayMoney,
							op.payStatus AS orderInfoPayStatus,
							op.payTime AS orderInfoPayTime,
							op.platformPayWater AS orderInfoPlatformPayWater,
							op.payName AS orderInfoPayName
						FROM
							order_before ob
						INNER JOIN source_shipper s ON (ob.sourceId = s.id)
						INNER JOIN member_info mi ON mi.id = s.assignMemberId
						LEFT JOIN member_cer mc ON mc.memberId = mi.id
						LEFT JOIN order_info oi ON oi.sourceId = ob.sourceId
						LEFT JOIN order_agent oa ON oa.sourceId = ob.sourceId
						LEFT JOIN member_car mr ON mr.id = ob.carId
						LEFT JOIN order_paydetail op ON (
							op.orderNo = oi.orderNo
							AND op.orderType = 2
						)
						WHERE ob.id =:id AND mi.id =:shipperMemberId
					) t
				LEFT JOIN (
					SELECT
						oa.sourceId AS sourceId,
						op.payMoney AS orderAgentPayMoney,
						op.payStatus AS orderAgentPayStatus,
						op.payTime AS orderAgentPayTime,
						op.platformPayWater AS orderAgentPlatformPayWater,
						op.payName AS orderAgentPayName,
						mc.realName AS driverRealName,
						mc.cerStatus AS driverCerStatus,
						mi.mobile AS driverMobile,
						mi.iconUrl AS driverIconUrl
					FROM
						order_agent oa
					LEFT JOIN order_paydetail op ON (
						oa.orderNo = op.orderNo
						AND op.orderType = 1
					)
					INNER JOIN member_info mi ON mi.id = oa.driverMemberId
					LEFT JOIN member_cer mc ON mc.memberId = mi.id
					WHERE
						oa.sourceId =:sourceId
				) p ON t.sourceId = p.sourceId
		
		]]>
	</sql>



	<!-- 查询货源详情 不包含支付信息 orderBeforeId sourceId -->
<!-- 	<sql id="querySourceBaseByIds">
			<![CDATA[
				SELECT 	s.id AS orderBeforeId,
					s.sourceId,
					s.orderBeforeStatus,
					s.s_detail,
					s.s_detailed_address,
					s.e_detail,
					s.e_detailed_address,
					s.mileage,
					s.sendDate,
					s.carLength,
					s.carType,
					s.sendGoodsType,
					s.goodsType,
					s.goodsName,
					s.totalWeight,
					s.totalSize,
					s.remark,
					s.freight,
					s.nstRule,
					s.sourceStatus,
					s.shipperName,
					s.shipperMobile,
					s.driverCarNumber,
					s.driverCarType,
					s.driverCarLoad,
					s.driverCarLength,
					(CASE s.nstRule WHEN 1 THEN  null ELSE m.userName  END ) AS goodsSource,
					m.id as memberId,
					(CASE s.nstRule WHEN 2 THEN  m.userName ELSE s.shipperName  END ) as  userName,
				    (CASE s.nstRule WHEN 2 THEN  m.mobile ELSE  s.shipperMobile END ) as  mobile,
					
					m.iconUrl,
					m.cerPersonalStatus
					 FROM 
					(  SELECT 
					ob.id,
					ob.sourceId,
					ob.carId,
					ob.sourceStatus AS orderBeforeStatus,
					s.s_detail,
					s.s_detailed_address,
					s.e_detail,
					s.e_detailed_address,
					s.mileage,
					s.sendDate,
					s.carLength,
					s.carType,
					s.sendGoodsType,
					s.goodsType,
					s.goodsName,
					s.totalWeight,
					s.totalSize,
					s.remark,
					s.freight,
					s.nstRule,
					s.sourceStatus,
					s.shipperName,
					s.shipperMobile,
					c.carNumber AS driverCarNumber,
					c.carType AS driverCarType,
					c.`load` AS driverCarLoad,
					c.carLength AS driverCarLength,
					(CASE s.nstRule WHEN 1 THEN s.memberId 
									WHEN 2 THEN s.assignMemberId 
									WHEN 4 THEN s.memberId
					ELSE 0 END ) AS goodsId
				 FROM  order_before ob,source_shipper s,member_car c WHERE s.id=ob.sourceId  AND ob.carId=c.id
				 
				 and ob.id=:orderBeforeId and s.id=:sourceId
				 
				 ) s LEFT JOIN member_info m ON s.goodsId=m.id 
		
			]]>
		</sql> -->

		<!-- 查询货源详情 包含支付信息 orderBeforeId sourceId  -->
		<sql id="querySourceByIds">
			<![CDATA[
				SELECT 	
				    s.id AS orderBeforeId,
					s.sourceId,
					s.orderBeforeStatus,
					s.s_detail,
					s.s_detailed_address,
					s.e_detail,
					s.e_detailed_address,
					s.sourceType,
					s.mileage,
					s.sendDate,
					s.carLength,
					s.carType,
					s.sendGoodsType,
					s.goodsType,
					s.goodsName,
					s.totalWeight,
					s.totalSize,
					s.remark,
					s.freight,
					s.nstRule,
					s.sourceStatus,
					s.shipperName,
					s.shipperMobile,
					s.driverMemberId,
					s.driverCarNumber,
					s.driverCarType,
					s.driverCarLoad,
					s.driverCarLength,
					(CASE s.nstRule WHEN 1 THEN null 
					WHEN 5 THEN '平台分配'
					ELSE '物流公司推荐'  END ) AS goodsSource,
					m.id as memberId,
					(CASE s.nstRule WHEN 2 THEN  m.userName ELSE s.shipperName  END ) as  userName,
				    (CASE s.nstRule WHEN 2 THEN  m.mobile ELSE  s.shipperMobile END ) as  mobile,
					m.iconUrl,
					m.cerPersonalStatus,
					oa.id AS  orderAgentId,
					oa.orderNo AS orderAgentNo,
					oa.orderStatus AS orderAgentStatus,
					oa.confirmTime AS agentConfirmTime,
					oa.logisticTime AS agentLogisticTime,
					oa.InfoAmt  AS orderAgentPayMoney,
					oa.payStatus AS orderAgentPayStatus,
					opa.payTime AS orderAgentPayTime,
					opa.platformPayWater AS orderAgentPlatformPayWater,
					opa.payName AS orderAgentPayName,
					
					oa.logisticMemberId as payeeUserId,
				    oa.logisticMobile as payeeMobile,
				    oa.logisticName as payeeName,
					
					oi.orderNo AS orderInfoNo,
					oi.orderStatus AS orderInfoStatus,
					oi.confirmOrderTime AS confirmOrderInfoTime,
					oi.confirmGoodsTime AS confirmGoodsInfoTime,
					oi.transportAmt AS orderInfoPayMoney,
					oi.payStatus AS orderInfoPayStatus,
					op.payTime AS orderInfoPayTime,
					op.platformPayWater AS orderInfoPlatformPayWater,
					op.payName AS orderInfoPayName
					 FROM  ( 
							 SELECT 
							ob.id,
							ob.sourceId,
							ob.carId,
							ob.sourceStatus AS orderBeforeStatus,
							s.memberId,
							s.s_detail,
							s.s_detailed_address,
							s.e_detail,
							s.e_detailed_address,
							s.sourceType,
							s.mileage,
							s.sendDate,
							s.carLength,
							s.carType,
							s.sendGoodsType,
							s.goodsType,
							s.goodsName,
							s.totalWeight,
							s.totalSize,
							s.remark,
							s.freight,
							s.nstRule,
							s.sourceStatus,
							s.shipperName,
							s.shipperMobile,
							ob.driverMemberId,
							c.carNumber AS driverCarNumber,
							c.carType AS driverCarType,
							c.`load` AS driverCarLoad,
							c.carLength AS driverCarLength,
							(CASE s.nstRule WHEN 1 THEN s.memberId 
									WHEN 2 THEN s.assignMemberId 
									WHEN 4 THEN s.memberId
									WHEN 5 THEN s.memberId
									ELSE 0 END ) AS goodsId	
						 FROM  order_before ob,source_shipper s,member_car c WHERE s.id=ob.sourceId  AND ob.carId=c.id
						 and ob.id=:orderBeforeId and s.id=:sourceId 
				 ) s 
				LEFT JOIN member_info m ON s.goodsId=m.id 
				LEFT JOIN order_info oi ON  oi.orderBeforeId=s.id  
				LEFT JOIN  order_agent oa ON   oa.orderBeforeId=s.id
				LEFT JOIN  order_paydetail op ON op.orderNo=oi.orderNo AND op.orderType  =2 AND op.payStatus=2
				LEFT JOIN   order_paydetail opa ON opa.orderNo=oa.orderNo AND opa.orderType  =1 AND opa.payStatus=2
			]]>
		</sql>
		
		
		
		<!-- 查询货源详情 包含支付信息 orderBeforeId sourceId  -->
		<!-- <sql id="querySourceAgentByIds">
			<![CDATA[
				SELECT 	s.id AS orderBeforeId,
					s.sourceId,
					s.orderBeforeStatus,
					s.s_detail,
					s.s_detailed_address,
					s.e_detail,
					s.e_detailed_address,
					s.mileage,
					s.sendDate,
					s.carLength,
					s.carType,
					s.sendGoodsType,
					s.goodsType,
					s.goodsName,
					s.totalWeight,
					s.totalSize,
					s.remark,
					s.freight,
					s.nstRule,
					s.sourceStatus,
					s.shipperName,
					s.shipperMobile,
					s.driverMemberId,
					s.driverCarNumber,
					s.driverCarType,
					s.driverCarLoad,
					s.driverCarLength,
					(CASE s.nstRule WHEN 1 THEN  null ELSE m.userName  END ) AS goodsSource,
					m.id as memberId,
					(CASE s.nstRule WHEN 2 THEN  m.userName ELSE s.shipperName  END ) as  userName,
				    (CASE s.nstRule WHEN 2 THEN  m.mobile ELSE  s.shipperMobile END ) as  mobile,
					m.iconUrl,
					m.cerPersonalStatus,
					oa.orderNo AS orderAgentNo,
					oa.orderStatus AS orderAgentStatus,
					oa.confirmTime AS agentConfirmTime,
					oa.logisticTime AS agentLogisticTime,
					oa.InfoAmt  AS orderAgentPayMoney,
					oa.payStatus AS orderAgentPayStatus,
					opa.payTime AS orderAgentPayTime,
					opa.platformPayWater AS orderAgentPlatformPayWater,
					opa.payName AS orderAgentPayName,
					
					oa.logisticMemberId as payeeUserId,
				    oa.logisticMobile as payeeMobile,
				    oa.logisticName as payeeName
				
					 FROM  ( 
							 SELECT 
							ob.id,
							ob.sourceId,
							ob.carId,
							ob.sourceStatus AS orderBeforeStatus,
							s.memberId,
							s.s_detail,
							s.s_detailed_address,
							s.e_detail,
							s.e_detailed_address,
							s.mileage,
							s.sendDate,
							s.carLength,
							s.carType,
							s.sendGoodsType,
							s.goodsType,
							s.goodsName,
							s.totalWeight,
							s.totalSize,
							s.remark,
							s.freight,
							s.nstRule,
							s.sourceStatus,
							s.shipperName,
							s.shipperMobile,
							ob.driverMemberId,
							c.carNumber AS driverCarNumber,
							c.carType AS driverCarType,
							c.`load` AS driverCarLoad,
							c.carLength AS driverCarLength,
							(CASE s.nstRule WHEN 1 THEN s.memberId 
									WHEN 2 THEN s.assignMemberId 
									WHEN 4 THEN s.memberId
									ELSE 0 END ) AS goodsId
						 FROM  order_before ob,source_shipper s,member_car c WHERE s.id=ob.sourceId  AND ob.carId=c.id
						 and ob.id=:orderBeforeId and s.id=:sourceId 
				 ) s 
				LEFT JOIN member_info m ON s.memberId=m.id  
				LEFT JOIN  order_agent oa ON   oa.orderBeforeId=s.id
				LEFT JOIN   order_paydetail opa ON opa.orderNo=oa.orderNo AND opa.orderType  =1 AND opa.payStatus=2
			]]>
		</sql> -->
	
			<!-- 根据货源ID 查询 -->
			<sql id="querySourceShipper">
			<![CDATA[
				SELECT
					id,memberId,sourceType,
					s_provinceId as sProvinceId,
					sourceStatus,
					nstRule,
					version,
					assignMemberId,
					e_provinceId as eProvinceId,
					shipperName,
					shipperMobile
				FROM
					source_shipper
				WHERE
					id=:id AND  isDeleted=0
					
			]]>
			</sql>

			<!-- 根据货源ID 修改状态 -->
			<sql id="updateSourceShipperStatus">
				<![CDATA[
					update source_shipper set 
					   sourceStatus=:sourceStatus,
					   updateTime=SYSDATE(),
					   version = version + 1
					WHERE
						id=:id and version=:version and isDeleted=0
				]]>
			</sql>

			<!-- <sql id="queryByConditionPage">
				<![CDATA[
						SELECT
							*
						FROM
							(
								(
									SELECT
										ob.id AS id,
										ob.sourceId AS sourceId,
										ob.driverMemberId AS driverMemberId,
										mc.realName AS realName,
										mc.cerStatus AS cerStatus,
										ob.sourceStatus AS sourceStatus,
										s.s_detailed_address AS s_detailed_address,
										s.e_detailed_address AS e_detailed_address,
										s.sendDate AS sendDate,
										s.goodsType AS goodsType,
										s.totalWeight AS totalWeight,
										s.totalSize AS totalSize,
										s.carLength AS carLength,
										s.carType AS carType,
										s.mileage AS mileage,
										ob.createTime AS createTime,
										mi.mobile AS mobile
									FROM
										order_before ob
									INNER JOIN source_shipper s ON (
										ob.sourceId = s.id
										AND s.isDeleted = 0
										AND s.assignMemberId != s.memberId
									)
									INNER JOIN member_info mi ON (mi.id = s.assignMemberId)
									LEFT JOIN member_cer mc ON mc.memberId = mi.id
									WHERE
										1 = 1
									<#if driverMemberId?exists && driverMemberId!="" >
										AND ob.driverMemberId=:driverMemberId
									</#if>
									<#if sourceStatus?exists && sourceStatus!="" >
										AND ob.sourceStatus=:sourceStatus
									</#if>
									<#if sourceStatus?exists && sourceStatus=4 >
										or ob.sourceStatus=5 or ob.sourceStatus=6
									</#if>
									ORDER BY
										ob.createTime DESC
								)
								UNION
									(
										SELECT
											ob.id AS id,
											ob.sourceId AS sourceId,
											ob.driverMemberId AS driverMemberId,
											mc.realName AS realName,
											mc.cerStatus AS cerStatus,
											ob.sourceStatus AS sourceStatus,
											s.s_detailed_address AS s_detailed_address,
											s.e_detailed_address AS e_detailed_address,
											s.sendDate AS sendDate,
											s.goodsType AS goodsType,
											s.totalWeight AS totalWeight,
											s.totalSize AS totalSize,
											s.carLength AS carLength,
											s.carType AS carType,
											s.mileage AS mileage,
											ob.createTime AS createTime,
											mi.mobile AS mobile
										FROM
											order_before ob
										INNER JOIN source_shipper s ON (
											ob.sourceId = s.id
											AND s.isDeleted = 0
											AND s.assignMemberId IS NULL
										)
										INNER JOIN member_info mi ON (mi.id = s.memberId)
										LEFT JOIN member_cer mc ON mc.memberId = mi.id
										WHERE
											1 = 1
										<#if driverMemberId?exists && driverMemberId!="" >
											AND ob.driverMemberId=:driverMemberId
										</#if>
										<#if sourceStatus?exists && sourceStatus!="" >
											AND ob.sourceStatus=:sourceStatus
										</#if>
										<#if sourceStatus?exists && sourceStatus=4 >
											or ob.sourceStatus=5 or ob.sourceStatus=6
										</#if>
										ORDER BY
											ob.createTime DESC
									)
							) AS t
						ORDER BY
							t.createTime DESC
							LIMIT :startRow,:endRow
				]]>
			</sql> -->


			<!--  车主订单管理  根据状态分页查询 订单  -->
			<sql id="queryByConditionPageNew">
				<![CDATA[
				
				    SELECT ss.*,
				     oi.payStatus, 
				    oi.id AS orderInfoId, 
				    oi.orderStatus,
				    m.id as memberId,
				    (CASE ss.nstRule WHEN 2 THEN  m.userName ELSE ss.shipperName  END ) as  userName,
				    (CASE ss.nstRule WHEN 2 THEN  m.mobile ELSE  ss.shipperMobile END ) as  mobile,
				    m.cerPersonalStatus,
				    m.iconUrl,
				    oa.id as orderAgentId,
				    oa.orderNo as orderAgentNo,
				    oa.payStatus,
				    oa.logisticTime as agentLogisticTime,
				    oa.confirmTime as confirmOrderInfoTime,
				    oa.id as orderAgentId,
				    oa.logisticMemberId as payeeUserId,
				    oa.logisticMobile as payeeMobile,
				    oa.logisticName as payeeName
				      FROM (
    					SELECT
 					ob.id   AS orderBeforeId,
       				 ob.createTime,
       				 ob.sourceStatus AS orderBeforeStatus,
       				 ob.updateTime,
				 		s.id   AS sourceId,
			           s.sourceType,
			           s.s_areaId,
			           s.s_cityId,
			           s.s_provinceId,
			           s.s_detail,
			           s.e_areaId,
			           s.e_cityId,
			           s.e_provinceId,
			           s.e_detail,
			           s.sendDate,
			           s.goodsName,
			           s.totalWeight,
			           s.totalSize,
			           s.carLength,
			           s.mileage,
			           s.carType,
			           s.sendGoodsType,
			           s.goodsType,
			           s.nstRule,
			           s.sourceStatus,
			           s.shipperName,
			           s.shipperMobile,
			           (CASE s.nstRule WHEN 1 THEN s.memberId WHEN 4 THEN s.memberId WHEN 2 THEN s.assignMemberId WHEN 5 THEN s.memberId ELSE 0 END ) AS memberId
			      FROM order_before ob LEFT JOIN  source_shipper s
			      ON s.id = ob.sourceId
			      WHERE  ob.driverMemberId=:driverMemberId  	
      					 <#if sourceStatus?exists && sourceStatus!="">   
							<#if sourceStatus=4>
								AND ob.sourceStatus in (4,5,6 )
							<#elseif sourceStatus=1 >   
									AND ob.sourceStatus=:sourceStatus and s.sourceStatus=2  and s.isDeleted=0  /* 订当待确认  货源待确认  */
							<#else>   
									AND ob.sourceStatus=:sourceStatus and s.sourceStatus=3	  /* 订当已确认  货源已确认  */
							</#if>
						</#if>
						
          				) ss  LEFT JOIN member_info m ON m.id=ss.memberId 
					LEFT JOIN order_info oi ON oi.orderBeforeId=ss.orderBeforeId   
					left join order_agent oa on ss.orderBeforeId=oa.orderBeforeId 
					ORDER BY ss.updateTime DESC 
				LIMIT :startRow,:endRow
					]]>
			</sql>

<!--  车主订单管理  根据状态分页查询 订单 统计 -->
	<sql id="getTotalNew">
				<![CDATA[
			SELECT 
			count(ss.orderBeforeId)
				 FROM (
    				SELECT
 					ob.id   AS orderBeforeId,
       				 ob.createTime,
       				 ob.sourceStatus AS orderBeforeStatus,
       				 ob.updateTime,
				 		s.id   AS sourceId,
			           s.sourceType,
			           s.s_areaId,
			           s.s_cityId,
			           s.s_provinceId,
			           s.s_detail,
			           s.e_areaId,
			           s.e_cityId,
			           s.e_provinceId,
			           s.e_detail,
			           s.sendDate,
			           s.goodsName,
			           s.totalWeight,
			           s.totalSize,
			           s.carLength,
			           s.mileage,
			           s.carType,
			           s.sendGoodsType,
			           s.goodsType,
			           s.nstRule,
			           s.sourceStatus,
			           s.shipperName,
			           s.shipperMobile,
			           (CASE s.nstRule WHEN 1 THEN s.memberId WHEN 4 THEN s.memberId WHEN 2 THEN s.assignMemberId WHEN 5 THEN s.memberId ELSE 0 END ) AS memberId
			       
			      FROM order_before ob LEFT JOIN  source_shipper s
			      ON s.id = ob.sourceId
			      WHERE  ob.driverMemberId=:driverMemberId 
			      					 
      					 <#if sourceStatus?exists && sourceStatus!="">   
							<#if sourceStatus=4>
								AND ob.sourceStatus in (4,5,6 )
							<#elseif sourceStatus=1 >   
									AND ob.sourceStatus=:sourceStatus and s.sourceStatus=2  /* 订当待确认  货源待确认  */
							<#else>   
									AND ob.sourceStatus=:sourceStatus and s.sourceStatus=3	 /* 订当已确认  货源已确认  */
							</#if>
						</#if>
      					
          				) ss  LEFT JOIN member_info m ON m.id=ss.memberId 
					LEFT JOIN order_info oi ON  oi.orderBeforeId=ss.orderBeforeId
				]]>
			</sql>
			
			<!-- <sql id="getTotal">
				<![CDATA[
						SELECT
							count(1)
						FROM
							(
								(
									SELECT
										ob.id AS id,
										ob.sourceId AS sourceId
									FROM
										order_before ob
									INNER JOIN source_shipper s ON (
										ob.sourceId = s.id
										AND s.isDeleted = 0
										AND s.assignMemberId != s.memberId
									)
									INNER JOIN member_info mi ON (mi.id = s.assignMemberId)
									LEFT JOIN member_cer mc ON mc.memberId = mi.id
									WHERE
										1 = 1
									
									<#if driverMemberId?exists && driverMemberId!="" >
										AND ob.driverMemberId=:driverMemberId
									</#if>
									<#if sourceStatus?exists && sourceStatus!="" >
										AND ob.sourceStatus=:sourceStatus
									</#if>
									ORDER BY
										ob.createTime DESC
								)
								UNION
									(
										SELECT
											ob.id AS id,
											ob.sourceId AS sourceId
										FROM
											order_before ob
										INNER JOIN source_shipper s ON (
											ob.sourceId = s.id
											AND s.isDeleted = 0
											AND s.assignMemberId IS NULL
										)
										INNER JOIN member_info mi ON (mi.id = s.memberId)
										LEFT JOIN member_cer mc ON mc.memberId = mi.id
										WHERE
											1 = 1
										<#if driverMemberId?exists && driverMemberId!="" >
											AND ob.driverMemberId=:driverMemberId
										</#if>
										<#if sourceStatus?exists && sourceStatus!="" >
											AND ob.sourceStatus=:sourceStatus
										</#if>
										ORDER BY
											ob.createTime DESC
									)
							) AS t
				]]>
			</sql> -->

			<!-- 根据预订单id更新预订单状态 -->
			<sql id="updateOrderBeforeStatusById">
				<![CDATA[
					UPDATE order_before
					SET sourceStatus = :orderBeforeStatus, updateTime = now(), updateUserId =:updateUserId
					WHERE 
						id = :orderBeforeId 
						<#if sourceShipperId?exists && sourceShipperId!="" >
							AND sourceId = :sourceShipperId
						</#if>
				]]>
			</sql>


			<!-- 查询司机订单 -->
			<sql id="queryOrderQuantity">
				<![CDATA[
				SELECT o.id, 
				    o.sourceId,
					o.carId,
					o.shipperMemberId,
					o.driverMemberId,
					o.sourceStatus,
					s.sourceType
				 FROM order_before  AS o,source_shipper  AS s 
				 WHERE o.isDeleted=0
				 AND o.sourceId=s.id
				 AND s.isDeleted=0  
				 AND driverMemberId=:driverMemberId
				 <#if sourceStatus?exists && sourceStatus!="" >
					AND s.sourceStatus=:sourceStatus 
				</#if>
				 <#if beforeSourceStatus?exists && beforeSourceStatus!="" >
					AND o.sourceStatus=:beforeSourceStatus 
				</#if>
				
				]]>
			</sql>
			
			
			<!-- 查询车主 业务类型 -->
		<sql id="queryMemberById">
	 	<![CDATA[
			SELECT 
			m.id,
			m.mobile,
			m.serviceType,
			m.userName,
			m.cerPersonalStatus,
			m.cerCompanyStatus,
			m.status
			FROM  member_info m
			WHERE m.id=:memberId 
			]]>
		</sql>
		
		
				<!-- 查询车主 业务类型 -->
		<sql id="queryMemberAllById">
	 	<![CDATA[
			SELECT 
			m.id,
			m.mobile,
			m.serviceType,
			m.userName,
			m.cerPersonalStatus,
			m.cerCompanyStatus,
			m.status
			FROM  member_info m
			WHERE m.id=:memberId
			]]>
		</sql>
		
		<!-- 统计司机车辆 -->
		 <sql id="getMemberCarNumber">
		 <![CDATA[
		    select  
		         count(1)
		       from member_car m   
		        where 
		        m.isDeleted=0
		        and
		       m.memberId=:memberId
		       ]]>
		</sql>  
</sqlMap>
