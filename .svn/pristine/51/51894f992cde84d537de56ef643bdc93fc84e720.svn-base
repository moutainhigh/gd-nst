package cn.gdeng.nst.server.ad.impl;

import java.util.Date;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import com.alibaba.dubbo.config.annotation.Service;

import cn.gdeng.nst.api.dto.ad.AdAllDto;
import cn.gdeng.nst.api.dto.ad.AdvertisementDto;
import cn.gdeng.nst.api.server.ad.AdService;
import cn.gdeng.nst.dao.BaseDao;
import cn.gdeng.nst.util.web.api.ApiResult;
import cn.gdeng.nst.util.web.api.BizException;
import cn.gdeng.nst.util.web.api.ParamProcessUtil;

/**
 * @author DJB
 * @version 创建时间：2016年8月1日 上午11:21:14 广告服务实现类
 */

@Service
public class AdServiceImpl implements AdService {

	//private Logger logger = LoggerFactory.getLogger(this.getClass());
	@Resource
	private BaseDao<?> baseDao;

	/**
	 * 
	 * @Description: 查询新广告和公告
	 * @param paraMap  省市  类型 
	 * @return
	 * @throws BizException
	 *
	 */
	@Override
	public ApiResult<AdAllDto> queryAdAllNew(Map<String, Object> paraMap) throws BizException {
		ApiResult<AdAllDto> result = new ApiResult<AdAllDto>();
		AdAllDto adAllDto = new AdAllDto();
		paraMap.put("nowTime", new Date());
		// 默认查询排序前五个，不需要返回总数
		List<AdvertisementDto> adBannerDtos = baseDao.queryForList("Advertisement.queryAdvertisement", paraMap, AdvertisementDto.class);
		
		if (adBannerDtos==null||adBannerDtos.isEmpty()) {
			 adBannerDtos = baseDao.queryForList("Advertisement.queryAdvertisementDefault", paraMap, AdvertisementDto.class);
		}
		List<Map<String, Object>> list = baseDao.queryForList("AdNotice.getAdNoticeNewest",paraMap);
		if(list.size()==0){
			paraMap.put("cityName", "默认");
	        list = baseDao.queryForList("AdNotice.getAdNoticeNewest",paraMap);
		}
		adAllDto.setAdBannerDtos(adBannerDtos);
		StringBuilder notice=new StringBuilder();
		if (list!=null&&!list.isEmpty()) {
			for (int i = 0; i < list.size(); i++) {
				if (ParamProcessUtil.mapKeyIsEmpty(list.get(i), "content")) {
					notice.append(list.get(i).get("content").toString());
					if (i!=list.size()-1) {
						notice.append("    ");
					}
				}
			}
		}
		adAllDto.setNotice(notice.toString());
		return result.withResult(adAllDto);
	}


}
